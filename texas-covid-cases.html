<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="description" content="Texas Covid-19 Map"/>
    <title>Texas Covid Cases</title>
    <style>
        * {
            margin: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen",
            "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue",
            sans-serif;
            background-color: #00000030;
        }

        #root {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .county {
            stroke: black;
            stroke-opacity: 0.5;
        }

        .D3Object {
            display: block;
            max-width: 100vw;
            max-height: 95vh;
        }

        .d3-tip {
            font-size: 12px;
            line-height: 1;
            font-weight: bold;
            padding: 12px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border-radius: 10px;
            pointer-events: none;
            text-align: left;
        }
    </style>
</head>
<body>
<div id="root"></div>
<script src="https://unpkg.com/d3@5.16.0/dist/d3.min.js"></script>
<script src="https://unpkg.com/d3-tip@0.9.1/dist/index.js"></script>
<script src="https://unpkg.com/topojson@3.0.2/dist/topojson.min.js"></script>
<script src="d3-abstraction-classes.js"></script>
<script>
  loadData = () =>
      Promise.all([
        d3.json('TexasCOVID19CaseCountData.json'),
        d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/counties-10m.json'),
      ]).then(([covidData, topoJSONData]) => {
        const objByCounty = covidData.counts.reduce((accumulator, d) => {
          accumulator[d.county] = {cases: d.cases, fatalities: d.fatalities};
          return accumulator;
        }, {});

        const counties = topojson.feature(topoJSONData,
            topoJSONData.objects.counties);
        // 48 is the FIPS code for Texas
        const filteredData = counties.features.filter(
            element => element['id'].startsWith('48'));
        filteredData.forEach(d => {
          Object.assign(d.properties, objByCounty[d.properties.name]);
        });
        return {timestamp: covidData.date, counties: filteredData};
      });

  loadData().then(data => {
    //console.log(data);
    const mapLabels = {
      className: 'labels',
      header: {id: 'title', text: 'Texas COVID-19 Case Counts'},
      subheader: {id: '', text: data.timestamp},
      footer: {id: 'source', text: 'Source: https://dshs.texas.gov/coronavirus/TexasCOVID19CaseCountData.xlsx'},
      left: {id: 'left-label', text: ''},
      right: {id: 'right-label', text: ''},
    };
    const counties = data.counties;
    const projection = d3.geoMercator();
    const colorScale = d3.scaleSequentialSqrt();
    const colorValue = d => d.properties.cases;
    const countyCollection = {type: 'FeatureCollection', features: counties};

    const texasMap = new D3Chart({tooltips: true, labels: mapLabels});
    texasMap.render();
    // Pan and zoom functionality is acting weirdly, needs investigation
    /*
        texasMap.svgGroups.plotGroup
            .call(d3.zoom()
                .on('zoom', () => {
                  texasMap.svgGroups.plotGroup.attr('transform', d3.event.transform);
                }));
    */
    const pathGenerator = d3.geoPath()
        .projection(projection.fitSize([texasMap.plotArea.width, texasMap.plotArea.height], countyCollection));

    colorScale
        .domain(d3.extent(counties.map(colorValue)))
        .interpolator(d3.interpolateReds);

    const paths = texasMap.svgGroups.plotGroup.selectAll('path').data(counties);
    tooltipDisplay = d => `<span>${d.properties.name}</span><br><span>Cases: ${d.properties.cases}</span><br><span>Deaths: ${d.properties.fatalities}</span>`;
    paths.enter()
        .append('path')
        .attr('class', 'county')
        .attr('d', d => pathGenerator(d))
        .attr('fill', d => colorScale(colorValue(d)));

    texasMap.addToolTips(counties, tooltipDisplay, {}, 'n', 'path');
    //console.log(texasMap);
  });
</script>
</body>
</html>